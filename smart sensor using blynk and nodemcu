/*
This smart sensor based on dht11 sensor module and nodemcu wifi module and blynk mobile app


*/

// display blynk information on serial monitor output
#define BLYNK_PRINT Serial 

// set up esp, blynk, dht and timer libraries
#include <ESP8266WiFi.h>
#include <BlynkSimpleEsp8266.h>
char auth[] = ""; //insert here your token generated by Blynk

#include <SimpleTimer.h>
SimpleTimer timer;

#include <DHT.h>
#define DHTPIN 5  //dht22 data in
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);
float humidity, temp_f; // Values read from sensor

// create a function called "sendData" and repeat it every x minutes, refer to line 162
void sendData(){
    float h = dht.readHumidity();
    float t = dht.readTemperature();
    // fahrenheit = t * 1.8 + 32.0;
    Blynk.virtualWrite(11, h);
    
    Blynk.virtualWrite(10, t);
    
    // Blynk.virtualWrite(12, fahrenheit);
    // delay(300);
	// print on serial monitor temp and humid values
    Serial.print("temperature C");
    Serial.println( t );
    Serial.print("humidity %");
    Serial.println( h );

  // checking for too lows and highs
  // email if necessary
  // blink the yellow alarm led if necessary
  if (t < 25){
  Blynk.email("osayrem@gmail.com", "ALARM", "Temp is below 5C");
  }

  if (t > 30){
  Blynk.email("osayrem@gmail.com", "ALARM", "Temp is above 40C");  
  Blynk.tweet("الدنيا حر جدا بره  !\n #smarthome #IoT  #esp8266");
    /*
    digitalWrite(4, HIGH);
    delay(300);
    digitalWrite(4, LOW);
    delay(300);
    digitalWrite(4, HIGH);
    
*/
  }

    if (h < 20){
    Blynk.email("osayrem@gmail.com", "ALARM", "Humid is below 20%"); 
    }
delay(1000);  

   if (h > 90){
    Blynk.email("osayrem@gmail.com", "ALARM", "Humid is above 90%"); 

    }

}

void setup(){

  Serial.begin(9600); 
  dht.begin();
  Blynk.begin(auth, "ap", "12345678"); //insert here your SSID and passwor

  Serial.print("device alive, go  to phone app");

  // trigger sendData function above every x seconds
  timer.setInterval(5000, sendData);  // 10000 = 10 seconds  (x/1000=seconds)

}

// everything is setup, now the system starts until power off
void loop(){
  Blynk.run();
  timer.run();

}
